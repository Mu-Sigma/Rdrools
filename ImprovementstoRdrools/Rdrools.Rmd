---
title: "Improvements to Rdrools package"
author: "Dheekshitha PS"
date: (`r format(Sys.Date(), "%B %d, %Y")`)
output:
  html_document:

    code_folding: show
    toc: yes
    toc_depth: 5
  html_notebook:
    toc: yes
    toc_depth: 5
  pdf_document:
    toc: yes
    toc_depth: '5'
---
```{r echo = FALSE, message = FALSE, results = 'hide', warning = FALSE, error=FALSE}
#Package installation if required for handbook
required.packages <- c('Rdrools','DT','lubridate')

for(pkg in required.packages){
  if(!require(pkg,character.only = T)){
    install.packages(pkg, repos = "http://cloud.r-project.org/")
    library(pkg)
  }
}

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Sourcing the required R scripts
source(file = "./Source/RdroolsUtils.R")


```

## Using Rdrools to execute Rules engine rules

### Sample data

 
 The sample data set provides transaction data for multiple users (identified by their *Account IDs*). Every transaction that a user (account) does is recorded with the following details:

  + *Transaction ID*: unique code for each transaction
  + *Transaction Amount*: the amount debited or credited in each transaction
  + *trans_tender_type*: tells if the transaction is a deposit or loan repayment or if it is an overseas transaction                    
  + *Date*: the transaction date
  + *Total transactions*: number of transactions done by the customer in each month and the cumulative number of transactions





```{r}


sampleData <- read.csv("./SampleDataset/TransactionsData.csv",stringsAsFactors = FALSE)
sampleData <-sampleData[1:200,]
#coverting the data to ymd format
sampleData$Date <- ymd(sampleData$Date)
str(sampleData)
```
#### Rules

In the above example, the user should provide the rules in the form of a list. The rules can be easily given using the function, *convertRules*. The function takes the parameters:
*sampleRules*: the rules defined in a csv 


Example of a sampleRules file is
```{r}
sampleRules <-read.csv("./SampleRules/Transactionrules.csv",stringsAsFactors = FALSE)
    
```
     
```{r,echo=FALSE}

datatable(
  head(sampleRules, 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```




------




#### Converting rule(in csv) to required format

```{r}

sampleRulesList <- convertRules(sampleRules = sampleRules,sampleData = sampleData)
```
The rule to group by the *Account_ID* can be given by using the **accumulate** function.
The accumulate function is similar to group by in dplyr. This can be used to group by a particular column and then apply aggregations like average, min, max, count, sum, collectList, collectSet. 
To use any other function other than the built-in functions(above mentioned) the user has to define the function and import it.
```{r,comment=NA}
sampleRulesList
```


#### Input columns

```{r}
sampleInputCols<- sampleRulesList[[2]]

sampleInputCols
``` 
#### Output columns

```{r}
sampleOutputCols<- sampleRulesList[[3]]
sampleOutputCols
#sampleOutputCols <- c("Account_ID", "Transaction_Amount","Credit_Debit_Indicator","Date","risk_level","Customer_ID","Balance","Result1","Result2")
``` 
#### Running the rules


```{r}
# sampleRulesUnList<-unlist(sampleRulesList[[1]],recursive = FALSE)
# sampleRulesSession <- rulesSession(sampleRulesUnList,sampleInputCols,sampleOutputCols)
# sampleRunRules <- runRules(sampleRulesSession,sampleData)
# View(sampleRunRules)
``` 
```{r}
#sampleRulesUnList<-unlist(sampleRulesList[[1]],recursive = FALSE)
sampleRulesList<- convertRules(sampleRules = sampleRules,sampleData = sampleData)

cat(paste(sampleRulesList[[1]][[1]], collapse = '\n'))
sampleRulesSession1 <- rulesSession(sampleRulesList[[1]][[1]],sampleInputCols,sampleOutputCols)
sampleRunRules1 <- runRules(sampleRulesSession1,sampleData)
sampleRunRules1
```
```{r}
cat(paste(sampleRulesList[[1]][[2]], collapse = '\n'))
sampleRulesSession2 <- rulesSession(sampleRulesList[[1]][[2]],sampleInputCols,sampleOutputCols)
sampleRunRules2 <- runRules(sampleRulesSession2,sampleData)
sampleRunRules2
```
```{r}
cat(paste(sampleRulesList[[1]][[3]], collapse = '\n'))
sampleRulesSession3 <- rulesSession(sampleRulesList[[1]][[3]],sampleInputCols,sampleOutputCols)
sampleRunRules3 <- runRules(sampleRulesSession3,sampleData)
sampleRunRules3
```
```{r}

cat(paste(sampleRulesList[[1]][[4]], collapse = '\n'))
sampleRulesSession4 <- rulesSession(sampleRulesList[[1]][[4]],sampleInputCols,sampleOutputCols)
sampleRunRules4 <- runRules(sampleRulesSession4,sampleData)
sampleRunRules4

```
```{r}
cat(paste(sampleRulesList[[1]][[5]], collapse = '\n'))
sampleRulesSession5 <- rulesSession(sampleRulesList[[1]][[5]],sampleInputCols,sampleOutputCols)
sampleRunRules5 <- runRules(sampleRulesSession5,sampleData)
sampleRunRules5
```
```{r}
cat(paste(sampleRulesList[[1]][[6]], collapse = '\n'))
sampleRulesSession6 <- rulesSession(sampleRulesList[[1]][[6]],sampleInputCols,sampleOutputCols)
sampleRunRules6 <- runRules(sampleRulesSession6,sampleData)
sampleRunRules6
```
```{r}
cat(paste(sampleRulesList[[1]][[7]], collapse = '\n'))
sampleRulesSession7 <- rulesSession(sampleRulesList[[1]][[7]],sampleInputCols,sampleOutputCols)
sampleRunRules7 <- runRules(sampleRulesSession7,sampleData)
sampleRunRules7

```



The above result has the cumulative sum for each *Account_ID* .








## References
[Drools documentation](https://docs.jboss.org/drools/release/6.5.0.Final/drools-docs/html_single/#d0e7610)

[Rdrools documentation](https://cran.r-project.org/web/packages/Rdrools/Rdrools.pdf)
