---
title: "Notebook to test rules"
author: "Dheekshitha PS"
date: "15 June 2018"
output:
  html_document:

    code_folding: show
    toc: yes
    toc_depth: 5
  html_notebook:
    toc: yes
    toc_depth: 5
  pdf_document:
    toc: yes
    toc_depth: '5'
---

```{r echo = FALSE, message = FALSE, results = 'hide', warning = FALSE, error=FALSE}
#Package installation if required for handbook
required.packages <- c('Rdrools','DT','lubridate','purrr','dplyr')

for(pkg in required.packages){
  if(!require(pkg,character.only = T)){
    install.packages(pkg, repos = "http://cloud.r-project.org/")
    library(pkg)
  }
}

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Sourcing the required R scripts
source(file = "./src/main/resources/Rdrools/R/Rdrools.R")


```
## Loading the sample data
```{r}


sampleData <- read.csv("./src/main/resources/Rdrools/data/SampleDataset/TransactionsData.csv",stringsAsFactors = FALSE)
sampleData <-sampleData[1:200,]
#coverting the data to ymd format
sampleData$Date <- ymd(sampleData$Date)
str(sampleData)
```

     
```{r,echo=FALSE}

datatable(
  head(sampleData, 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```



## Loading the sample rules


Each rule in the below is csv is:
Rule1: No filter, aggregation by multiple columns
Rule2: Filter and aggregation by multiple columns
Rule3: Filter and aggregation by one column
Rule4: No filter and aggregation by one column
Rule5: Only filter,no aggregation
Rule6: NO filter, aggregation on whole column
```{r}
sampleRules <-read.csv("./src/main/resources/Rdrools/data/SampleRules/workingRules.csv",stringsAsFactors = FALSE)
sampleRules[is.na(sampleRules)]    <-""
```
  
```{r,echo=FALSE}

datatable(
  head(sampleRules, 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```



## Running the rules
The function, *executeRulesOnDataset* returns two objects: 
  
  * perRule: the list containing the each rule in drl format and csv format
  * outputDf: the dataframe with all the input columns and one column for each rule (with flags true/false)
```{r}
output<- executeRulesOnDataset(dataset=sampleData,rules = sampleRules)

```
```{r}

datatable(
  head(output[[2]], 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```



-----


## Rule in csv and drl format
```{r,message=NA}
output[[1]][1]
```

## Output per rule
The function, *getRuleWiseData* will give output for each rule separately. If there is *aggregation* in any of the rules, the output will have only the *groupby* column and the flag but not all the rows.
```{r}
eachRuleoutput <- getRuleWiseData(dataset = sampleData,outputDf = output[[2]],rules = sampleRules)

```


-----




The below rule has two *groupby* columns
```{r}

datatable(
  head(eachRuleoutput[[1]], 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```



------



The below rule has *no* *groupby* columns and only filter, hence all the rows are returned
```{r}

datatable(
  head(eachRuleoutput[[5]], 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```



-----



The below rule has *no* *groupby* columns and *no filter*, aggreagtion is done on whole column, hence all the rows are returned
```{r}

datatable(
  head(eachRuleoutput[[6]], 20), extensions = 'FixedColumns',
  options = list(
  dom = 't',
  scrollX = TRUE,
  scrollCollapse = TRUE
))
```